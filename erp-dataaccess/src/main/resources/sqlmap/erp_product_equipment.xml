<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lxzl.erp.dataaccess.dao.mysql.product.ProductEquipmentMapper">

    <resultMap id="ProductEquipmentDO" type="com.lxzl.erp.dataaccess.domain.product.ProductEquipmentDO">
        <id column="id" jdbcType="INTEGER" property="id" />
        <result column="equipment_no" jdbcType="VARCHAR" property="equipmentNo" />
        <result column="product_id" jdbcType="INTEGER" property="productId" />
        <result column="product_name" jdbcType="VARCHAR" property="productName"/>
        <result column="sku_id" jdbcType="INTEGER" property="skuId" />
        <result column="warehouse_id" jdbcType="INTEGER" property="warehouseId" />
        <result column="warehouse_position_id" jdbcType="INTEGER" property="warehousePositionId" />
        <result column="owner_warehouse_id" jdbcType="INTEGER" property="ownerWarehouseId" />
        <result column="owner_warehouse_position_id" jdbcType="INTEGER" property="ownerWarehousePositionId" />
        <result column="equipment_price" jdbcType="DECIMAL" property="equipmentPrice" />
        <result column="equipment_status" property="equipmentStatus"/>
        <result column="data_status" property="dataStatus"/>
        <result column="remark" property="remark"/>
        <result column="create_user" jdbcType="VARCHAR" property="createUser"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_user" jdbcType="VARCHAR" property="updateUser"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <collection property="productImgDOList" resultMap="ProductImgDO" />
        <collection property="bulkMaterialDOList" resultMap="BulkMaterialDO" />
    </resultMap>


    <resultMap id="BulkMaterialDO" type="com.lxzl.erp.dataaccess.domain.material.BulkMaterialDO">
        <id column="bulk_id" jdbcType="INTEGER" property="id" />
        <result column="bulk_bulk_material_no" jdbcType="VARCHAR" property="bulkMaterialNo" />
        <result column="bulk_bulk_material_type" jdbcType="INTEGER" property="bulkMaterialType" />
        <result column="bulk_bulk_material_name" jdbcType="VARCHAR" property="bulkMaterialName" />
        <result column="bulk_material_id" jdbcType="INTEGER" property="materialId" />
        <result column="bulk_material_no" jdbcType="VARCHAR" property="materialNo" />
        <result column="bulk_warehouse_id" jdbcType="INTEGER" property="warehouseId" />
        <result column="bulk_warehouse_position_id" jdbcType="INTEGER" property="warehousePositionId" />
        <result column="bulk_owner_warehouse_id" jdbcType="INTEGER" property="ownerWarehouseId" />
        <result column="bulk_owner_warehouse_position_id" jdbcType="INTEGER" property="ownerWarehousePositionId" />
        <result column="bulk_brand_id" jdbcType="INTEGER" property="brandId" />
        <result column="bulk_category_id" jdbcType="INTEGER" property="categoryId" />
        <result column="bulk_property_id" jdbcType="INTEGER" property="propertyId" />
        <result column="bulk_property_value_id" jdbcType="INTEGER" property="propertyValueId" />
        <result column="bulk_bulk_material_price" jdbcType="DECIMAL" property="bulkMaterialPrice" />
        <result column="bulk_original_price" jdbcType="DECIMAL" property="originalPrice" />
        <result column="bulk_rent_price" jdbcType="DECIMAL" property="rentPrice" />
        <result column="bulk_bulk_material_status" jdbcType="INTEGER" property="bulkMaterialStatus" />
        <result column="bulk_data_status" jdbcType="INTEGER" property="dataStatus" />
        <result column="bulk_remark" jdbcType="VARCHAR" property="remark" />
        <result column="bulk_create_time" jdbcType="TIMESTAMP" property="createTime" />
        <result column="bulk_create_user" jdbcType="VARCHAR" property="createUser" />
        <result column="bulk_update_time" jdbcType="TIMESTAMP" property="updateTime" />
        <result column="bulk_update_user" jdbcType="VARCHAR" property="updateUser" />
    </resultMap>

    <resultMap id="ProductImgDO" type="com.lxzl.erp.dataaccess.domain.product.ProductImgDO">
        <id column="img_id" jdbcType="INTEGER" property="id"/>
        <result column="img_img_type" jdbcType="INTEGER" property="imgType"/>
        <result column="img_original_name" jdbcType="VARCHAR" property="originalName"/>
        <result column="img_product_id" jdbcType="INTEGER" property="productId"/>
        <result column="img_img_url" jdbcType="VARCHAR" property="imgUrl"/>
        <result column="img_data_status" jdbcType="INTEGER" property="dataStatus"/>
        <result column="img_is_main" jdbcType="INTEGER" property="isMain"/>
        <result column="img_img_order" jdbcType="INTEGER" property="imgOrder"/>
        <result column="img_remark" jdbcType="VARCHAR" property="remark"/>
        <result column="img_create_user" jdbcType="VARCHAR" property="createUser"/>
        <result column="img_create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="img_update_user" jdbcType="VARCHAR" property="updateUser"/>
        <result column="img_update_time" jdbcType="TIMESTAMP" property="updateTime"/>
    </resultMap>
    <sql id="column_List">
        epe.id,epe.equipment_no,epe.product_id,epe.sku_id,epe.warehouse_id,epe.warehouse_position_id,epe.owner_warehouse_id,epe.owner_warehouse_position_id,epe.equipment_price,epe.equipment_status,epe.data_status,epe.remark,epe.create_user,epe.create_time,epe.update_user,epe.update_time
    </sql>
    <sql id="img_column_List">
        epi.id as img_id,epi.img_type as img_img_type,epi.original_name as img_original_name,epi.product_id as img_product_id,epi.img_url as img_img_url,epi.data_status as img_data_status,epi.remark as img_remark,epi.is_main as img_is_main,epi.img_order as img_img_order,epi.create_user as img_create_user,epi.create_time as img_create_time,epi.update_user as img_update_user,epi.update_time as img_update_time
    </sql>

    <sql id="bulk_material_column_List">
        ebm.id AS bulk_id,ebm.bulk_material_no AS bulk_bulk_material_no,ebm.bulk_material_type AS bulk_bulk_material_type,ebm.bulk_material_name AS bulk_bulk_material_name,ebm.material_id AS bulk_material_id,ebm.material_no AS bulk_material_no,ebm.warehouse_id AS bulk_warehouse_id,ebm.warehouse_position_id AS bulk_warehouse_position_id,ebm.owner_warehouse_id AS bulk_owner_warehouse_id,ebm.owner_warehouse_position_id AS bulk_owner_warehouse_position_id,ebm.brand_id AS bulk_brand_id,ebm.category_id AS bulk_category_id,ebm.property_id AS bulk_property_id,ebm.property_value_id AS bulk_property_value_id,ebm.bulk_material_price AS bulk_bulk_material_price,ebm.original_price AS bulk_original_price,ebm.rent_price AS bulk_rent_price,ebm.bulk_material_status AS bulk_bulk_material_status,ebm.data_status AS bulk_data_status,ebm.remark AS bulk_remark,ebm.create_time AS bulk_create_time,ebm.create_user AS bulk_create_user,ebm.update_time AS bulk_update_time,ebm.update_user AS bulk_update_user
    </sql>

    <select id="findById" resultMap="ProductEquipmentDO" parameterType="java.lang.Integer">
        SELECT equipment_main.*
            <trim prefix=",">
                <include refid="bulk_material_column_List" />
            </trim>
            <trim prefix=",">
                <include refid="img_column_List" />
            </trim>
        FROM
        (
            SELECT <include refid="column_List"/>
            FROM erp_product_equipment epe
            INNER JOIN erp_product mp ON epe.product_id = mp.id
            where epe.id = #{id, jdbcType=INTEGER} and epe.data_status = 1
        ) equipment_main LEFT JOIN erp_product_equipment_bulk_material epebm ON equipment_main.id = epebm.equipment_id and epebm.data_status = 1
        LEFT JOIN erp_bulk_material ebm ON epebm.bulk_material_id = ebm.id AND ebm.data_status = 1
        LEFT JOIN erp_product_img epi ON epi.product_id = equipment_main.product_id AND epi.data_status = 1 AND epi.img_type = 1
    </select>

    <select id="findByEquipmentNo" resultMap="ProductEquipmentDO" parameterType="java.lang.String">
        SELECT equipment_main.*
        <trim prefix=",">
            <include refid="bulk_material_column_List" />
        </trim>
        <trim prefix=",">
            <include refid="img_column_List" />
        </trim>
        FROM
        (
            SELECT <include refid="column_List"/>
            FROM erp_product_equipment epe
            INNER JOIN erp_product mp ON epe.product_id = mp.id
            where epe.equipment_no = #{equipmentNo, jdbcType=INTEGER} and epe.data_status = 1
        ) equipment_main LEFT JOIN erp_product_equipment_bulk_material epebm ON equipment_main.id = epebm.equipment_id and epebm.data_status = 1
        LEFT JOIN erp_bulk_material ebm ON epebm.bulk_material_id = ebm.id AND ebm.data_status = 1
        LEFT JOIN erp_product_img epi ON epi.product_id = equipment_main.product_id AND epi.data_status = 1 AND epi.img_type = 1
    </select>

    <select id="findProductEquipmentByParams" resultMap="ProductEquipmentDO" parameterType="map">
        SELECT product_equipment.*
        <trim prefix=",">
            <include refid="img_column_List" />
        </trim>
        FROM
        (
            select
            <include refid="column_List"/>
            , mp.product_name AS product_name
            from erp_product_equipment epe
            INNER JOIN erp_product mp ON epe.product_id = mp.id
            <where>
                <if test="maps.productEquipmentQueryParam.productEquipmentId != null">
                    and epe.id = #{maps.productEquipmentQueryParam.productEquipmentId, jdbcType=INTEGER}
                </if>
                <if test="maps.productEquipmentQueryParam.equipmentNo != null &amp;&amp; maps.productEquipmentQueryParam.equipmentNo != ''">
                    and epe.equipment_no = #{maps.productEquipmentQueryParam.equipmentNo, jdbcType=INTEGER}
                </if>
                <if test="maps.productEquipmentQueryParam.productId != null">
                    and epe.product_id = #{maps.productEquipmentQueryParam.productId, jdbcType=INTEGER}
                </if>
                <if test="maps.productEquipmentQueryParam.productName != null &amp;&amp; maps.productEquipmentQueryParam.productName != ''">
                    and mp.product_name like CONCAT('%','${maps.productEquipmentQueryParam.productName}','%' )
                </if>
                <if test="maps.productEquipmentQueryParam.skuId != null">
                    and epe.sku_id = #{maps.productEquipmentQueryParam.skuId, jdbcType=INTEGER}
                </if>
                <if test="maps.productEquipmentQueryParam.equipmentStatus != null">
                    and epe.equipment_status = #{maps.productEquipmentQueryParam.equipmentStatus, jdbcType=INTEGER}
                </if>
                <if test="maps.productEquipmentQueryParam.createStartTime != null &amp;&amp; maps.productEquipmentQueryParam.createStartTime != ''">
                    <![CDATA[ AND epe.create_time >= #{maps.productEquipmentQueryParam.createStartTime} ]]>
                </if>
                <if test="maps.productEquipmentQueryParam.createEndTime != null &amp;&amp; maps.productEquipmentQueryParam.createEndTime != ''">
                    <![CDATA[ AND epe.create_time <= #{maps.productEquipmentQueryParam.createEndTime} ]]>
                </if>
                <if test="true">
                    and epe.data_status = 1
                </if>
            </where>
            LIMIT #{maps.start},#{maps.pageSize}
        ) product_equipment
        LEFT JOIN erp_product_img epi ON epi.product_id = product_equipment.product_id AND epi.data_status = 1 AND epi.img_type = 1
        ORDER BY product_equipment.create_time DESC,epi.is_main DESC
    </select>

    <select id="findProductEquipmentCountByParams" resultType="java.lang.Integer" parameterType="map">
        select count(epe.id)
        from erp_product_equipment epe
        INNER JOIN erp_product mp ON epe.product_id = mp.id
        <where>
            <if test="maps.productEquipmentQueryParam.productEquipmentId != null">
                and epe.id = #{maps.productEquipmentQueryParam.productEquipmentId, jdbcType=INTEGER}
            </if>
            <if test="maps.productEquipmentQueryParam.equipmentNo != null &amp;&amp; maps.productEquipmentQueryParam.equipmentNo != ''">
                and epe.equipment_no = #{maps.productEquipmentQueryParam.equipmentNo, jdbcType=INTEGER}
            </if>
            <if test="maps.productEquipmentQueryParam.productName != null &amp;&amp; maps.productEquipmentQueryParam.productName != ''">
                and mp.product_name like CONCAT('%','${maps.productEquipmentQueryParam.productName}','%' )
            </if>
            <if test="maps.productEquipmentQueryParam.productId != null">
                and epe.product_id = #{maps.productEquipmentQueryParam.productId, jdbcType=INTEGER}
            </if>
            <if test="maps.productEquipmentQueryParam.skuId != null">
                and epe.sku_id = #{maps.productEquipmentQueryParam.skuId, jdbcType=INTEGER}
            </if>
            <if test="maps.productEquipmentQueryParam.equipmentStatus != null">
                and epe.equipment_status = #{maps.productEquipmentQueryParam.equipmentStatus, jdbcType=INTEGER}
            </if>
            <if test="maps.productEquipmentQueryParam.createStartTime != null &amp;&amp; maps.productEquipmentQueryParam.createStartTime != ''">
                <![CDATA[ AND epe.create_time >= #{maps.productEquipmentQueryParam.createStartTime} ]]>
            </if>
            <if test="maps.productEquipmentQueryParam.createEndTime != null &amp;&amp; maps.productEquipmentQueryParam.createEndTime != ''">
                <![CDATA[ AND epe.create_time <= #{maps.productEquipmentQueryParam.createEndTime} ]]>
            </if>
            <if test="true">
                and epe.data_status = 1
            </if>
        </where>
    </select>


    <sql id="set_column_sql">
        <set>
            <if test="materialNo != null">
                material_no = #{materialNo,jdbcType=VARCHAR},
            </if>
            <if test="materialName != null">
                material_name = #{materialName,jdbcType=VARCHAR},
            </if>
            <if test="brandId != null">
                brand_id = #{brandId,jdbcType=INTEGER},
            </if>
            <if test="categoryId != null">
                category_id = #{categoryId,jdbcType=INTEGER},
            </if>
            <if test="propertyId != null">
                property_id = #{propertyId,jdbcType=INTEGER},
            </if>
            <if test="propertyValueId != null">
                property_value_id = #{propertyValueId,jdbcType=INTEGER},
            </if>
            <if test="materialPrice != null">
                material_price = #{materialPrice,jdbcType=DECIMAL},
            </if>
            <if test="originalPrice != null">
                original_price = #{originalPrice,jdbcType=DECIMAL},
            </if>
            <if test="rentPrice != null">
                rent_price = #{rentPrice,jdbcType=DECIMAL},
            </if>
            <if test="dataStatus != null">
                data_status = #{dataStatus,jdbcType=INTEGER},
            </if>
            <if test="remark != null">
                remark = #{remark,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createUser != null">
                create_user = #{createUser,jdbcType=VARCHAR},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateUser != null">
                update_user = #{updateUser,jdbcType=VARCHAR},
            </if>
            <if test="materialDesc != null">
                material_desc = #{materialDesc,jdbcType=LONGVARCHAR},
            </if>
        </set>
    </sql>


    <insert id="saveList" parameterType="java.util.ArrayList">
        insert into erp_product_equipment (equipment_no,product_id,sku_id,warehouse_id,warehouse_position_id,owner_warehouse_id,owner_warehouse_position_id,equipment_price,equipment_status,data_status,remark,create_time,create_user,update_time,update_user)
        <foreach item="productEquipmentDO" collection="productEquipmentDOList" separator="UNION ALL">
            SELECT #{productEquipmentDO.equipmentNo},#{productEquipmentDO.productId},#{productEquipmentDO.skuId},#{productEquipmentDO.warehouseId},#{productEquipmentDO.warehousePositionId},#{productEquipmentDO.ownerWarehouseId},
            #{productEquipmentDO.ownerWarehousePositionId},eps.rent_price,#{productEquipmentDO.equipmentStatus},#{productEquipmentDO.dataStatus},#{productEquipmentDO.remark},
            #{productEquipmentDO.createTime},#{productEquipmentDO.createUser},#{productEquipmentDO.updateTime},#{productEquipmentDO.updateUser}
            FROM erp_product_sku eps WHERE eps.id = #{productEquipmentDO.skuId}
        </foreach>
    </insert>

    <update id="update" parameterType="com.lxzl.erp.dataaccess.domain.product.ProductEquipmentDO">
        update erp_product_equipment
        <include refid="set_column_sql"/>
        WHERE id = #{id, jdbcType=INTEGER}
    </update>

    <insert id="save" keyProperty="id" useGeneratedKeys="true"
            parameterType="com.lxzl.erp.dataaccess.domain.product.ProductEquipmentDO">
        INSERT INTO mall_product_equipment
        <include refid="set_column_sql"/>
    </insert>
</mapper>
